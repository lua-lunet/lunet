name: Build

on:
  push:
    branches: [ main, xmake ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      ref:
        description: 'Branch or tag to build'
        required: false
        default: ''

permissions:
  contents: write

# Cancel previous runs when a new commit is pushed to the same PR/branch.
concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.ref }}
  cancel-in-progress: true

jobs:
  build:
    name: ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.ref || github.ref }}

    - name: Cache vcpkg
      uses: actions/cache@v4
      with:
        path: |
          vcpkg/installed
          vcpkg/packages
        key: ${{ runner.os }}-vcpkg-${{ hashFiles('xmake.lua') }}-${{ hashFiles('vcpkg.json', 'ports/*/vcpkg.json') }}
        restore-keys: |
          ${{ runner.os }}-vcpkg-

    - name: Install xmake
      uses: xmake-io/github-action-setup-xmake@v1
      with:
        xmake-version: latest

    - name: Install Dependencies (Linux)
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y pkg-config libuv1-dev luajit libluajit-5.1-dev

    - name: Install Dependencies (macOS)
      if: runner.os == 'macOS'
      run: |
        brew install pkg-config libuv luajit

    - name: Setup vcpkg (Windows)
      if: runner.os == 'Windows'
      uses: lukka/run-vcpkg@v11
      with:
        vcpkgGitCommitId: '66c0373dc7fca549e5803087b9487edfe3aca0a1'
      env:
        VCPKG_BINARY_SOURCES: 'clear;nuget,readwrite'

    - name: Install Dependencies (Windows)
      if: runner.os == 'Windows'
      run: |
        vcpkg install libuv:x64-windows
        vcpkg install luajit:x64-windows
        vcpkg install libpq[lz4,openssl,zlib]:x64-windows

    - name: Configure (Unix)
      if: runner.os != 'Windows'
      run: xmake f -m release -y

    - name: Configure (Windows)
      if: runner.os == 'Windows'
      shell: pwsh
      run: |
        $env:VCPKG_ROOT = "${{ github.workspace }}/vcpkg"
        $env:VCPKG_DEFAULT_TRIPLET = "x64-windows"
        $env:CL = "/MP"
        $env:CI = "true"
        xmake f -m release -y

    - name: Build
      run: |
        xmake build

    - name: Package release archive (Linux)
      if: runner.os == 'Linux'
      run: |
        set -euo pipefail
        DIST_DIR="$(mktemp -d)"
        mkdir -p "$DIST_DIR/lunet"
        cp "$(find build -type f -name 'lunet-run' | head -n 1)" "$DIST_DIR/lunet-run"
        cp "$(find build -type f -name 'lunet.so' | head -n 1)" "$DIST_DIR/lunet.so"
        while IFS= read -r mod; do
          cp "$mod" "$DIST_DIR/lunet/"
        done < <(find build -type f -path '*/lunet/*.so')
        tar -C "$DIST_DIR" -czf lunet-linux-amd64.tar.gz .

    - name: Package release archive (macOS)
      if: runner.os == 'macOS'
      run: |
        set -euo pipefail
        DIST_DIR="$(mktemp -d)"
        mkdir -p "$DIST_DIR/lunet"
        cp "$(find build -type f -name 'lunet-run' | head -n 1)" "$DIST_DIR/lunet-run"
        cp "$(find build -type f -name 'lunet.so' | head -n 1)" "$DIST_DIR/lunet.so"
        while IFS= read -r mod; do
          cp "$mod" "$DIST_DIR/lunet/"
        done < <(find build -type f -path '*/lunet/*.so')
        tar -C "$DIST_DIR" -czf lunet-macos.tar.gz .

    - name: Package release archive (Windows)
      if: runner.os == 'Windows'
      shell: pwsh
      run: |
        $ErrorActionPreference = "Stop"
        $dist = Join-Path $env:RUNNER_TEMP ("lunet-dist-" + $env:GITHUB_RUN_ID + "-" + $env:GITHUB_RUN_ATTEMPT)
        New-Item -ItemType Directory -Path (Join-Path $dist "lunet") -Force | Out-Null
        Copy-Item (Get-ChildItem -Path build -Recurse -Filter lunet-run.exe | Select-Object -First 1).FullName (Join-Path $dist "lunet-run.exe")
        Copy-Item (Get-ChildItem -Path build -Recurse -Filter lunet.dll | Select-Object -First 1).FullName (Join-Path $dist "lunet.dll")
        Get-ChildItem -Path build -Recurse -Filter *.dll | Where-Object { $_.FullName -match '\\lunet\\' } | ForEach-Object {
          Copy-Item $_.FullName (Join-Path $dist "lunet")
        }
        Compress-Archive -Path (Join-Path $dist "*") -DestinationPath lunet-windows-amd64.zip -Force

    - name: Upload artifact (Linux)
      if: runner.os == 'Linux'
      uses: actions/upload-artifact@v4
      with:
        name: lunet-linux-amd64
        path: |
          build/**/lunet-run
          build/**/lunet.so
          build/**/lunet/*.so

    - name: Upload artifact (macOS)
      if: runner.os == 'macOS'
      uses: actions/upload-artifact@v4
      with:
        name: lunet-macos
        path: |
          build/**/lunet-run
          build/**/lunet.so
          build/**/lunet/*.so

    - name: Upload artifact (Windows)
      if: runner.os == 'Windows'
      uses: actions/upload-artifact@v4
      with:
        name: lunet-windows-amd64
        path: |
          build/**/lunet-run.exe
          build/**/lunet.dll
          build/**/lunet/*.dll

    - name: Upload release archive (Linux)
      if: runner.os == 'Linux'
      uses: actions/upload-artifact@v4
      with:
        name: release-linux
        path: lunet-linux-amd64.tar.gz

    - name: Upload release archive (macOS)
      if: runner.os == 'macOS'
      uses: actions/upload-artifact@v4
      with:
        name: release-macos
        path: lunet-macos.tar.gz

    - name: Upload release archive (Windows)
      if: runner.os == 'Windows'
      uses: actions/upload-artifact@v4
      with:
        name: release-windows
        path: lunet-windows-amd64.zip

  easy-memory:
    name: EasyMem QA (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.ref || github.ref }}

    - name: Cache vcpkg
      uses: actions/cache@v4
      with:
        path: |
          vcpkg/installed
          vcpkg/packages
        key: ${{ runner.os }}-vcpkg-${{ hashFiles('xmake.lua') }}-${{ hashFiles('vcpkg.json', 'ports/*/vcpkg.json') }}
        restore-keys: |
          ${{ runner.os }}-vcpkg-

    - name: Install xmake
      uses: xmake-io/github-action-setup-xmake@v1
      with:
        xmake-version: latest

    - name: Install Dependencies (Linux)
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          pkg-config \
          libuv1-dev \
          luajit \
          libluajit-5.1-dev \
          libsqlite3-dev \
          libpq-dev \
          default-libmysqlclient-dev

    - name: Install Dependencies (macOS)
      if: runner.os == 'macOS'
      run: |
        brew install pkg-config libuv luajit libpq mysql-client coreutils
        echo "PKG_CONFIG_PATH=$(brew --prefix libpq)/lib/pkgconfig:$(brew --prefix mysql-client)/lib/pkgconfig:$PKG_CONFIG_PATH" >> $GITHUB_ENV

    - name: Setup vcpkg (Windows)
      if: runner.os == 'Windows'
      uses: lukka/run-vcpkg@v11
      with:
        vcpkgGitCommitId: '66c0373dc7fca549e5803087b9487edfe3aca0a1'
      env:
        VCPKG_BINARY_SOURCES: 'clear;nuget,readwrite'

    - name: Install Dependencies (Windows)
      if: runner.os == 'Windows'
      run: |
        vcpkg install libuv:x64-windows
        vcpkg install luajit:x64-windows
        vcpkg install sqlite3:x64-windows

    - name: Configure EasyMem + ASAN (Unix)
      if: runner.os != 'Windows'
      run: xmake f -c -m debug --lunet_trace=y --lunet_verbose_trace=n --asan=y --easy_memory=y -y

    - name: Configure EasyMem + ASAN (Windows)
      if: runner.os == 'Windows'
      shell: pwsh
      run: |
        $env:VCPKG_ROOT = "${{ github.workspace }}/vcpkg"
        $env:VCPKG_DEFAULT_TRIPLET = "x64-windows"
        $env:CL = "/MP"
        $env:CI = "true"
        xmake f -c -m debug --lunet_trace=y --lunet_verbose_trace=n --asan=y --easy_memory=y -y

    - name: Build Core + DB Drivers (EasyMem + ASAN)
      if: runner.os != 'Windows'
      run: |
        xmake build lunet-bin
        xmake build lunet-sqlite3
        xmake build lunet-mysql
        xmake build lunet-postgres

    - name: Build Core + SQLite Driver (EasyMem + ASAN, Windows)
      if: runner.os == 'Windows'
      run: |
        xmake build lunet-bin
        xmake build lunet-sqlite3

    - name: Run light DB stress (Unix)
      if: runner.os != 'Windows'
      run: |
        LUNET_BIN=$(find build -name 'lunet-run' -type f | head -1)
        if command -v gtimeout &>/dev/null; then TMO=gtimeout; else TMO=timeout; fi
        $TMO 60 env ASAN_OPTIONS=detect_leaks=0 LIGHT_DB_STRESS_OPS=20 "$LUNET_BIN" test/ci_easy_memory_db_stress.lua

    - name: LSAN regression (Unix)
      if: runner.os != 'Windows'
      run: |
        LUNET_BIN=$(find build -name 'lunet-run' -type f | head -1)
        if command -v gtimeout &>/dev/null; then TMO=gtimeout; else TMO=timeout; fi
        # Run with LSAN leak detection ON.  exitcode=23 lets us distinguish
        # "leaks detected" from "crash".  The MySQL C++ runtime has a known
        # fixed overhead of ~4 allocations that do not grow with usage.
        set +e
        LSAN_OPTIONS=exitcode=23 LSAN_STRESS_ITERATIONS=10 \
          $TMO 60 "$LUNET_BIN" test/ci_easy_memory_lsan_regression.lua 2>lsan_stderr.txt
        rc=$?
        set -e
        cat lsan_stderr.txt >&2
        if [ $rc -eq 0 ]; then
          echo "LSAN: clean — no leaks detected"
        elif [ $rc -eq 23 ]; then
          allocs=$(grep -oE '[0-9]+ allocation' lsan_stderr.txt | tail -1 | grep -oE '[0-9]+')
          echo "LSAN: $allocs allocation(s) leaked"
          if [ -n "$allocs" ] && [ "$allocs" -le 4 ]; then
            echo "LSAN: within known MySQL C++ runtime overhead (threshold: 4)"
          else
            echo "LSAN: EXCEEDS known threshold of 4 — possible real leak"
            exit 1
          fi
        else
          echo "LSAN: process failed with exit code $rc"
          exit $rc
        fi

    - name: Run light DB stress (Windows)
      if: runner.os == 'Windows'
      shell: pwsh
      run: |
        $lunet = Get-ChildItem -Path build -Recurse -Filter "lunet-run.exe" | Select-Object -First 1
        if (-not $lunet) { throw "lunet-run.exe not found" }
        $env:LIGHT_DB_STRESS_OPS = "20"
        & $lunet.FullName test/ci_easy_memory_db_stress.lua

    - name: Configure EasyMem experimental release (Unix)
      if: runner.os != 'Windows'
      run: xmake f -c -m release --lunet_trace=n --lunet_verbose_trace=n --easy_memory_experimental=y --easy_memory_arena_mb=128 -y

    - name: Configure EasyMem experimental release (Windows)
      if: runner.os == 'Windows'
      shell: pwsh
      run: |
        $env:VCPKG_ROOT = "${{ github.workspace }}/vcpkg"
        $env:VCPKG_DEFAULT_TRIPLET = "x64-windows"
        $env:CL = "/MP"
        $env:CI = "true"
        xmake f -c -m release --lunet_trace=n --lunet_verbose_trace=n --easy_memory_experimental=y --easy_memory_arena_mb=128 -y

    - name: Build Core + DB Drivers (EasyMem experimental, Unix)
      if: runner.os != 'Windows'
      run: |
        xmake build lunet-bin
        xmake build lunet-sqlite3
        xmake build lunet-mysql
        xmake build lunet-postgres

    - name: Build Core + SQLite Driver (EasyMem experimental, Windows)
      if: runner.os == 'Windows'
      run: |
        xmake build lunet-bin
        xmake build lunet-sqlite3

  publish-release:
    name: Publish release
    if: startsWith(github.ref, 'refs/tags/v') || (github.event_name == 'workflow_dispatch' && startsWith(github.event.inputs.ref, 'v'))
    needs: [build, easy-memory]
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.ref || github.ref }}

    - name: Download release archives
      uses: actions/download-artifact@v4
      with:
        pattern: release-*
        merge-multiple: true
        path: release-assets

    - name: Create or update GitHub release
      uses: softprops/action-gh-release@v2
      with:
        name: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.ref || github.ref_name }}
        body_path: .github/release-template.md
        generate_release_notes: true
        files: |
          release-assets/lunet-linux-amd64.tar.gz
          release-assets/lunet-macos.tar.gz
          release-assets/lunet-windows-amd64.zip
