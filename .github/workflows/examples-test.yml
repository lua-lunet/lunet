name: Examples Test

on:
  workflow_dispatch:
    inputs:
      ref:
        description: "Branch or tag to test"
        required: false
        default: ""

jobs:
  examples:
    name: ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: true
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.ref || github.ref }}

      - uses: xmake-io/github-action-setup-xmake@v1
        with:
          xmake-version: latest

      - name: Install Dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            pkg-config \
            libuv1-dev \
            luajit \
            libluajit-5.1-dev \
            libsqlite3-dev \
            libpq-dev \
            default-libmysqlclient-dev

      - name: Install Dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install pkg-config libuv luajit libpq mysql-client coreutils
          echo "PKG_CONFIG_PATH=$(brew --prefix libpq)/lib/pkgconfig:$(brew --prefix mysql-client)/lib/pkgconfig:$PKG_CONFIG_PATH" >> $GITHUB_ENV

      - name: Setup vcpkg (Windows)
        if: runner.os == 'Windows'
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgGitCommitId: 'f9d8eecab99cb23e4befb7ea90b2f9504d311b54'

      - name: Install Dependencies (Windows)
        if: runner.os == 'Windows'
        run: |
          vcpkg install libuv:x64-windows luajit:x64-windows sqlite3:x64-windows libmysql:x64-windows libpq:x64-windows

      - name: Configure (Unix)
        if: runner.os != 'Windows'
        run: xmake f -m release -y

      - name: Configure (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $env:VCPKG_ROOT = "${{ github.workspace }}/vcpkg"
          $env:VCPKG_DEFAULT_TRIPLET = "x64-windows"
          xmake f -m release -y

      - name: Build Core
        run: xmake build

      - name: Build Drivers
        run: |
          xmake build lunet-sqlite3
          xmake build lunet-mysql
          xmake build lunet-postgres

      - name: Examples Compile Check (Unix)
        if: runner.os != 'Windows'
        run: |
          LUNET_BIN=$(find build -name 'lunet-run' -type f | head -1)
          echo "Found binary: $LUNET_BIN"
          $LUNET_BIN test/ci_examples_compile.lua

      - name: SQLite3 Example Smoke (Unix)
        if: runner.os != 'Windows'
        run: |
          LUNET_BIN=$(find build -name 'lunet-run' -type f | head -1)
          $LUNET_BIN examples/03_db_sqlite3.lua

      - name: Examples Compile Check (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $lunet = Get-ChildItem -Path build -Recurse -Filter "lunet-run.exe" | Select-Object -First 1
          if (-not $lunet) { throw "lunet-run.exe not found" }
          & $lunet.FullName test/ci_examples_compile.lua

      - name: SQLite3 Example Smoke (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $lunet = Get-ChildItem -Path build -Recurse -Filter "lunet-run.exe" | Select-Object -First 1
          if (-not $lunet) { throw "lunet-run.exe not found" }
          & $lunet.FullName examples/03_db_sqlite3.lua

      - name: Configure EasyMem + ASAN (Unix)
        if: runner.os != 'Windows'
        run: xmake f -c -m debug --lunet_trace=y --lunet_verbose_trace=n --asan=y --easy_memory=y -y

      - name: Configure EasyMem + ASAN (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $env:VCPKG_ROOT = "${{ github.workspace }}/vcpkg"
          $env:VCPKG_DEFAULT_TRIPLET = "x64-windows"
          xmake f -c -m debug --lunet_trace=y --lunet_verbose_trace=n --asan=y --easy_memory=y -y

      - name: Build Core + Drivers (EasyMem + ASAN)
        run: |
          xmake build lunet-bin
          xmake build lunet-sqlite3
          xmake build lunet-mysql
          xmake build lunet-postgres

      - name: EasyMem DB Stress (Unix)
        if: runner.os != 'Windows'
        run: |
          LUNET_BIN=$(find build -name 'lunet-run' -type f | head -1)
          if command -v gtimeout &>/dev/null; then TMO=gtimeout; else TMO=timeout; fi
          $TMO 60 env ASAN_OPTIONS=detect_leaks=0 LIGHT_DB_STRESS_OPS=20 "$LUNET_BIN" test/ci_easy_memory_db_stress.lua

      - name: LSAN regression (Unix)
        if: runner.os != 'Windows'
        run: |
          LUNET_BIN=$(find build -name 'lunet-run' -type f | head -1)
          if command -v gtimeout &>/dev/null; then TMO=gtimeout; else TMO=timeout; fi
          set +e
          LSAN_OPTIONS=exitcode=23 LSAN_STRESS_ITERATIONS=10 \
            $TMO 60 "$LUNET_BIN" test/ci_easy_memory_lsan_regression.lua 2>lsan_stderr.txt
          rc=$?
          set -e
          cat lsan_stderr.txt >&2
          if [ $rc -eq 0 ]; then
            echo "LSAN: clean â€” no leaks detected"
          elif [ $rc -eq 23 ]; then
            allocs=$(grep -oE '[0-9]+ allocation' lsan_stderr.txt | tail -1 | grep -oE '[0-9]+')
            echo "LSAN: $allocs allocation(s) leaked"
            if [ -n "$allocs" ] && [ "$allocs" -eq 4 ]; then
              echo "LSAN: known fixed MySQL C++ runtime overhead confirmed (exactly 4 allocations)"
            else
              echo "LSAN: unexpected allocation count (expected exactly 4 when leaks are reported)"
              exit 1
            fi
          else
            echo "LSAN: process failed with exit code $rc"
            exit $rc
          fi

      - name: EasyMem DB Stress (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $lunet = Get-ChildItem -Path build -Recurse -Filter "lunet-run.exe" | Select-Object -First 1
          if (-not $lunet) { throw "lunet-run.exe not found" }
          $env:LIGHT_DB_STRESS_OPS = "20"
          & $lunet.FullName test/ci_easy_memory_db_stress.lua
