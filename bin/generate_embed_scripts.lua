import("lib.detect.find_tool")

local MAGIC = "LUNETPK1"

local function parse_args(argv)
    local args = {
        source = os.getenv("LUNET_EMBED_SOURCE") or "lua",
        output = os.getenv("LUNET_EMBED_OUTPUT"),
        project_root = os.getenv("LUNET_EMBED_PROJECT_ROOT") or "."
    }
    local i = 1
    if argv[i] == "--" then
        i = i + 1
    end
    while i <= #argv do
        local key = argv[i]
        if key == "--" then
            i = i + 1
        else
            local val = argv[i + 1]
            if not val then
                raise("missing value for argument: %s", tostring(key))
            end
            if key == "--source" then
                args.source = val
            elseif key == "--output" then
                args.output = val
            elseif key == "--project-root" then
                args.project_root = val
            else
                raise("unknown argument: %s", tostring(key))
            end
            i = i + 2
        end
    end
    if not args.output then
        raise("missing required --output argument")
    end
    return args
end

local function u32le(value)
    local x = math.floor(value)
    return string.char(
        x % 256,
        math.floor(x / 256) % 256,
        math.floor(x / 65536) % 256,
        math.floor(x / 16777216) % 256
    )
end

local function u64le(value)
    local x = math.floor(value)
    local out = {}
    for i = 1, 8 do
        out[i] = string.char(x % 256)
        x = math.floor(x / 256)
    end
    return table.concat(out)
end

local function normalize_relpath(p)
    return (p or ""):gsub("\\", "/")
end

local function build_manifest(source_dir, payload_path)
    local files = os.files(path.join(source_dir, "**"))
    table.sort(files)

    local payload = assert(io.open(payload_path, "wb"))
    payload:write(MAGIC)
    payload:write(u32le(#files))

    for _, abs in ipairs(files) do
        local rel = normalize_relpath(path.relative(abs, source_dir))
        local data = assert(io.readfile(abs, {encoding = "binary"}))
        payload:write(u32le(#rel))
        payload:write(u64le(#data))
        payload:write(rel)
        payload:write(data)
    end

    payload:close()
end

local function gzip_manifest(payload_path, gzip_path)
    local gzip = assert(find_tool("gzip"), "gzip not found in PATH")
    os.vrunv(gzip.program,
             {"-n", "-c", path.filename(payload_path)},
             {curdir = path.directory(payload_path), stdout = gzip_path})
end

local function emit_header(gzip_path, output_path)
    local blob = assert(io.readfile(gzip_path, {encoding = "binary"}))
    assert(#blob > 0, "gzip output is empty")

    local out = assert(io.open(output_path, "wb"))
    out:write("/* Auto-generated by bin/generate_embed_scripts.lua. */\n")
    out:write("#ifndef LUNET_EMBED_SCRIPTS_BLOB_GENERATED_H\n")
    out:write("#define LUNET_EMBED_SCRIPTS_BLOB_GENERATED_H\n\n")
    out:write("#include <stddef.h>\n\n")
    out:write("const unsigned char lunet_embedded_scripts_gzip[] = {\n")
    for i = 1, #blob do
        if (i - 1) % 12 == 0 then
            out:write("  ")
        end
        out:write(string.format("0x%02x", blob:byte(i)))
        if i < #blob then
            out:write(", ")
        end
        if i % 12 == 0 then
            out:write("\n")
        end
    end
    if #blob % 12 ~= 0 then
        out:write("\n")
    end
    out:write("};\n")
    out:write(string.format("const size_t lunet_embedded_scripts_gzip_len = %d;\n\n", #blob))
    out:write("#endif\n")
    out:close()
end

local function main()
    local args = parse_args(arg or {})
    local source_dir = path.absolute(args.source, args.project_root)
    local output_path = path.absolute(args.output, args.project_root)

    assert(os.isdir(source_dir), "embed source directory not found: " .. source_dir)
    os.mkdir(path.directory(output_path))

    local payload_path = output_path .. ".payload.bin"
    local gzip_path = output_path .. ".payload.bin.gz"

    build_manifest(source_dir, payload_path)
    gzip_manifest(payload_path, gzip_path)
    emit_header(gzip_path, output_path)

    os.tryrm(payload_path)
    os.tryrm(gzip_path)
end

main()
