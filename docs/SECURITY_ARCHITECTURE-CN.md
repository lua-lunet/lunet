# 安全架构

lunet 推荐 qmail 风格的进程隔离架构——这正是让 qmail 在十多年间成为最安全邮件服务器的方法。

核心原则：将系统分解为信任边界，每个进程具有最小权限，并通过受限接口进行通信。面向互联网的攻击面由经过加固、久经考验的软件处理；lunet 永远不直接接触恶意网络。

```
┌─────────────────────────────────────────────────────────────────────┐
│                          恶意互联网                                  │
└───────────────────────────────┬─────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────┐
│                       面向互联网的边缘层                              │
│                          （您的选择）                                 │
│                                                                     │
│   nginx · OpenResty · Apache httpd · HAProxy · Caddy · Traefik     │
│   AWS ALB/NLB · GCP Load Balancer · Azure App Gateway              │
│   Cloudflare · Fastly · Kong · Kubernetes Ingress                  │
│                                                                     │
│   职责：                                                             │
│   • TLS 终止（HTTPS、HTTP/2、HTTP/3/QUIC）                          │
│   • 协议验证与攻击缓解                                                │
│   • 速率限制、WAF、DDoS 防护                                         │
│   • 证书管理                                                         │
└───────────────────────────────┬─────────────────────────────────────┘
                                │
                    Unix 套接字（首选）
                       或 TCP 环回
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────┐
│                          lunet                                      │
│                                                                     │
│   • 仅监听 Unix 套接字或 TCP 环回地址                                  │
│   • 永不暴露于公共网络接口                                             │
│   • 接收由您的边缘层预过滤的流量                                        │
│   • Unix 套接字增加了文件系统权限控制                                    │
└─────────────────────────────────────────────────────────────────────┘
```

## 为什么选择 Unix 套接字而非 TCP 环回？

TCP 环回（`127.0.0.1`）会将您暴露给同一主机上的其他进程。被攻击的服务、容器逃逸或配置错误的防火墙规则都可能允许本地攻击者连接。

Unix 套接字使用文件系统权限——只有具有正确 UID/GID 的进程才能连接。

## 支持的协议

lunet 是协议无关的。您的边缘层转发什么，lunet 就处理什么：

| 类别 | 协议 |
|------|------|
| Web | HTTP/1.1、WebSocket |
| RPC | gRPC、JSON-RPC、XML-RPC |
| 消息传递 | STOMP、MQTT、AMQP、XMPP |
| 数据 | Redis 协议、Memcached 协议 |
| 游戏 | Source RCON、Minecraft 协议、Photon、ENet |
| 自定义 | 任何基于帧或长度前缀的二进制协议 |

## 出站 TLS 客户端（可选）

本文档中“在边缘终止 TLS”的建议针对的是**入站暴露面**，并不禁止出站 HTTPS 客户端流量。

某些应用（例如调用 LLM 提供商的 MCP 服务器）需要出站 HTTPS，但不需要接收入站的公网 HTTPS 连接。
此时应保持入站绑定仅限 Unix 套接字或 `127.0.0.1`，并通过出站客户端模块访问远程 API。

Lunet 支持一个可选的**仅客户端** HTTPS 模块：
- `lunet.httpc`（libcurl），用于出站 `https://...` 请求

默认开启 TLS 校验。仅用于开发的逃生阀可通过 `LUNET_HTTPC_INSECURE=1` 启用（生产环境不要使用）。
